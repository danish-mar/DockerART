{% extends 'layout.html' %}

{% block customHead %}
  <!-- Include jQuery library -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<!-- Include toastr from CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

<!-- Include SweetAlert2 CSS and JS files -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.all.min.js"></script>


  <!-- Include Bootstrap JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* Custom modal styles */
    .modal-content {
      background-color: #141827; /* Set background color */
      color: #BDBCC8; /* Set text color */
    }
  
    .modal-header {
      background-color: #36406B; /* Set header background color */
      color: #BDBCC8; /* Set header text color */
    }
  
    .modal-footer {
      background-color: #36406B; /* Set footer background color */
      color: #BDBCC8; /* Set footer text color */
    }
  
    /* Customize close button color */
    .btn-close {
      color: #BDBCC8;
    }


      /* Custom modal styles */
  .modal-content {
    background-color: #141827; /* Set background color */
    color: #BDBCC8; /* Set text color */
    border: 1px solid #BDBCC8; /* Add border */
  }

  .modal-header {
    background-color: #36406B; /* Set header background color */
    color: #BDBCC8; /* Set header text color */
    border-bottom: 1px solid #BDBCC8; /* Add border to header */
  }

  .modal-footer {
    background-color: #36406B; /* Set footer background color */
    color: #BDBCC8; /* Set footer text color */
    border-top: 1px solid #BDBCC8; /* Add border to footer */
  }

  /* Customize close button color */
  .btn-close {
    color: #BDBCC8;
  }

  /* Set table styles */
  .table {
    color: white; /* Set font color */
  }



  .btn-primary {
    background-color: #36406B; /* Set primary button background color */
    border-color: #36406B; /* Set primary button border color */
  }

  .btn-danger {
    background-color: #BDBCC8; /* Set danger button background color */
    border-color: #BDBCC8; /* Set danger button border color */
  }

  .btn-secondary {
    background-color: #857891; /* Set secondary button background color */
    border-color: #857891; /* Set secondary button border color */
  }

  .btn-link {
    color: #857891; /* Set link button color */
  }


/* Add this CSS to your stylesheet or in a <style> tag in your HTML */

/* Apply the color palette to SweetAlert2 */
.swal2-popup {
    background-color: #141827;
    color: #BDBCC8;
  }
  
  .swal2-title {
    color: #857891;
  }
  
  .swal2-content {
    color: #BDBCC8;
  }
  
  .swal2-confirm {
    background-color: #36406B;
    color: #BDBCC8;
  }
  
  .swal2-cancel {
    background-color: #857891;
    color: #BDBCC8;
  }
  
  /* Create a transparent, blurred background */
  .swal2-container {
    background: rgba(0, 0, 0, 0.5); /* Adjust the alpha value for transparency */
    backdrop-filter: blur(10px); /* Adjust the blur intensity as needed */
  }
  
  /* Adjust the styling for the toast */
  .toast {
    background-color: #36406B;
    color: #BDBCC8;
  }
  
  
  </style>
  
{% endblock %}

{% block title %}Network ‚óè DockerART{% endblock %}

{% block menubar %}
  <div class="dropdown-menu xnavbar" aria-labelledby="manageDropdown">
    <a class="dropdown-item" href="/container"><i class="fa-solid fa-cube"></i> Container</a>
    <a class="dropdown-item" href="/images"><i class="fa-solid fa-floppy-disk"></i> Image</a>
    <a class="dropdown-item" href="#"><i class="fa-solid fa-hard-drive"></i> Disks</a>
    <a class="dropdown-item" href="#"><i class="fa-solid fa-network-wired"></i> Network</a>
  </div>
{% endblock %}
 
{% block content %}
  <div class="container mt-4">
    <h1><i class="fa-solid fa-network-wired"></i> Network Details</h1>


        <!-- Button to open the "Add Network" modal -->
        <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#addNetworkModal">
          <i class="fa-solid fa-plus"></i> Add Network
      </button>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Network Name</th>
          <th>Driver</th>
          <th>Connected Containers</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="networkTableBody">
        <!-- Network details will be dynamically added here using JS -->
      </tbody>
    </table>
  </div>


  <!-- Modal for adding network -->
<div class="modal fade" id="addNetworkModal" tabindex="-1" role="dialog" aria-labelledby="addNetworkModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addNetworkModalLabel"><i class="fa-solid fa-network-wired"></i> Add Network</h5>
      </div>
      <div class="modal-body">
        <label for="networkName">Network Name:</label>
        <input type="text" class="form-control" autocomplete="off"  id="networkName" required>
        
        <label for="subnet">Subnet:</label>
        <input type="text" class="form-control" id="subnet" placeholder="e.g., 172.20.0.0/16">
        
        <label for="gateway">Gateway:</label>
        <input type="text" class="form-control" id="gateway"  placeholder="e.g., 172.20.0.1">
        
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="internal">
          <label class="form-check-label" for="internal">Internal Network</label>
        </div>
        
        <label for="driver">Driver:</label>
        <input type="text" class="form-control"  id="driver" placeholder="e.g., bridge">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="addNetwork()">Add Network</button>
      </div>
    </div>
  </div>
</div>

  <!-- Modal for network inspection -->
  <div class="modal fade" id="networkInspectModal" tabindex="-1" role="dialog" aria-labelledby="networkInspectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="networkInspectModalLabel"><i class="fa-solid fa-ethernet"></i> Inspect Network</h5>
        </div>
        <div class="modal-body" id="networkInspectContent">
          <!-- Network details will be dynamically added here using JS -->
        </div>
        <div class="modal-footer">
        </div>
      </div>
    </div>
  </div>

  <!-- Add Container Modal -->
<div class="modal fade" id="addContainerModal" tabindex="-1" role="dialog" aria-labelledby="addContainerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addContainerModalLabel"><i class="fa-solid fa-plus"></i> Add Container to Network</h5>
        </div>
        <div class="modal-body">
          <label for="containerDropdown">Select Container:</label>
          <select class="form-control" id="containerDropdown"></select>
          <input type="hidden" id="selectedNetworkId">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="addContainerToNetwork()">Add Container</button>
        </div>
      </div>
    </div>
  </div>
  

  <script>


    
    // JavaScript for dynamically populating network details
    // JavaScript for dynamically populating network details
    function populateNetworkTable(networks) {
      const tableBody = document.getElementById('networkTableBody');
    
      networks.forEach(network => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${network.network_name}</td>
          <td>${network.driver}</td>
          <td>${network.connected_containers.join(', ')}</td>
          <td>
            <button class="btn btn-danger" onclick="deleteNetwork('${network.network_id}')">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
            <button class="btn btn-primary" onclick="inspectNetwork('${network.network_id}')">
              <i class="fa-solid fa-eye"></i> Inspect
            </button>
            <button class="btn btn-success" onclick="openAddContainerModal('${network.network_id}')">
              <i class="fa-solid fa-plus"></i> Add Container
            </button>
          </td>
        `;
    
        tableBody.appendChild(row);
      });
    }
    
    // JavaScript for dynamically populating container dropdown in the add container modal
    function populateContainerDropdown(containers) {

      

      const containerDropdown = document.getElementById('containerDropdown');
    

        containerDropdown.innerHTML = '';


      containers.forEach(container => {
        const option = document.createElement('option');
        option.value = container.Name;
        option.textContent = container.Name;
        containerDropdown.appendChild(option);
      });
    }
    
    // JavaScript for opening the add container modal
    function openAddContainerModal(networkId) {
      // Fetch container list from /api/docker-manage/list
      fetch('/api/docker-manage/list')
        .then(response => response.json())
        .then(containers => {
          // Populate the container dropdown in the modal
          populateContainerDropdown(containers);
    
          // Open the add container modal
          $('#addContainerModal').modal('show');
    
          // Set the networkId in a hidden field for reference
          document.getElementById('selectedNetworkId').value = networkId;
        })
        .catch(error => console.error('Error fetching container list:', error));
    }
    
    function addContainerToNetwork() {
      const containerName = document.getElementById('containerDropdown').value;
      const networkId = document.getElementById('selectedNetworkId').value;
    
      // Make a POST request to connect the container to the network
      fetch('/api/docker-manage/network/connect-container', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          container_name: containerName,
          network_name: networkId,
        }),
      })
        .then(response => response.json())
        .then(result => {
          // Close the modal
          $('#addContainerModal').modal('hide');
    
          // Display a toast with the result
          showColorPaletteToast(result.message, 'success');
        })
        .catch(error => {
          // Handle error and show error toast
          console.error('Error adding container to network:', error);
          showColorPaletteToast('Error adding container to network', 'error');
        });
    }
    
    function showColorPaletteToast(message, type) {
      // Define color palette
      const colorPalette = ["#141827", "#36406B", "#BDBCC8", "#857891"];
    
      // Use the color corresponding to the type
      const color = type === 'success' ? colorPalette[0] : colorPalette[1];
    
      // Show the toast
      toastr.options = {
        closeButton: true,
        positionClass: 'toast-bottom-right',
        showDuration: '300',
        hideDuration: '1000',
        timeOut: '5000',
        extendedTimeOut: '1000',
        backgroundColor: color,  // Fix the typo: 'backgroundcolor' to 'backgroundColor'
      };
    
      toastr[type](message);
    }
    
// JavaScript for dynamically populating network inspection modal
function populateNetworkInspectModal(networkDetails, netID) {
    const modalContent = document.getElementById('networkInspectContent');
    modalContent.innerHTML = `
      <p><strong><i class="fa-solid fa-pencil"></i> Network Name:</strong> ${networkDetails.network_name}</p>
      <p><strong><i class="fa-solid fa-fingerprint"></i> Network ID:</strong> ${netID}</p>
      <p><strong><i class="fa-solid fa-subscript"></i> Network Subnet:</strong> ${networkDetails.network_subnet}</p>
      <p><strong><i class="fa-solid fa-route"></i> Network Gateway:</strong> ${networkDetails.network_gateway}</p>
      <p><strong><i class="fa-solid fa-cubes-stacked"></i> Connected Containers:</strong></p>
      <ul>
        ${networkDetails.connected_containers.map(container => `
          <li>
            <strong>Container Name:</strong> ${container.container_name}<br>

            <strong>MAC Address:</strong> ${container.mac_address}<br>
            <strong>IPv4 Address:</strong> ${container.ipv4_address || 'None'}<br>
            <strong>IPv6 Address:</strong> ${container.ipv6_address || 'None'}
          </li>

          <button class="btn btn-danger" onclick="disconnectContainer('${container.container_name}', '${networkDetails.network_name}')">
            <i class="fa-solid fa-unlink"></i> Unlink
          </button><br>
          <hr>
        `).join('')}
      </ul>
    `;
  }
  

    // Function to inspect a network
    function inspectNetwork(networkId) {
      // Fetch network details using AJAX or fetch API
      fetch('/api/docker-manage/network/getNetworkDetail', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ network_id: networkId }),
      })
      .then(response => response.json())
      .then(data => {
        // Populate the network inspection modal
        populateNetworkInspectModal(data,networkId);
        // Show the modal
        $('#networkInspectModal').modal('show');
      })
      .catch(error => console.error('Error:', error));
    }

    // Function to delete a network
    function deleteNetwork(networkId) {
      // Implement network deletion logic here
      console.log('Deleting network with ID:', networkId);
    }

    // Function to disconnect a container from a network
    function disconnectContainer(containerName, networkName) {
      // Implement container disconnection logic here
      console.log(`Disconnecting container ${containerName} from network ${networkName}`);
    }

    // Fetch and populate network details on page load
    fetch('/api/docker-manage/network/getDetailedNetwork')
      .then(response => response.json())
      .then(data => populateNetworkTable(data))
      .catch(error => console.error('Error:', error));

      function disconnectContainer(containerName, networkName) {
        // Create a payload for the API request
        const payload = {
          container_name: containerName,
          network_name: networkName,
        };
      
        // Make a POST request to your API endpoint
        fetch('/api/docker-manage/network/disconnect-container', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              // Show a success toast
              showColorPaletteToast('Container disconnected successfully!', 'success');
            } else {
              // Show an error toast
              showColorPaletteToast(`Error disconnecting container: ${data.message}`, 'error');
            }
          })
          .catch(error => {
            // Show an error toast for network/API errors
            showColorPaletteToast(`Error disconnecting container: ${error}`, 'error');
          });
      }

      function showColorPaletteToast(message, type) {
        // Define color palette
        const colorPalette = ["#141827", "#36406B", "#BDBCC8", "#857891"];
      
        // Use the color corresponding to the type
        const color = type === 'success' ? colorPalette[0] : colorPalette[1];
      
        // Show the toast
        toastr.options = {
          closeButton: true,
          positionClass: 'toast-bottom-right',
          showDuration: '300',
          hideDuration: '1000',
          timeOut: '5000',
          extendedTimeOut: '1000',
          backgroundcolor: color,  // Set background color based on type
        };
      
        toastr[type](message);
      }

      
      

      // Function to delete a Docker network with confirmation
function deleteNetwork(networkID) {
    // Show a confirmation dialog using SweetAlert2
    Swal.fire({
      title: 'Are you sure?',
      text: 'This action cannot be undone!',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        // User confirmed, proceed with the deletion
        performNetworkDeletion(networkID);
      }
    });
  }
  
  // Function to actually perform the network deletion after confirmation
  function performNetworkDeletion(networkID) {
    // Create a payload for the API request
    const payload = {
      network_id: networkID,
    };
  
    // Make a POST request to your API endpoint
    fetch('/api/docker-manage/network/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Show a success toast
          showColorPaletteToast('Network deleted successfully!', 'success');
        } else {
          // Show an error toast
          showColorPaletteToast(`Error deleting network: ${data.message}`, 'error');
        }
      })
      .catch(error => {
        // Show an error toast for network/API errors
        showColorPaletteToast(`Error deleting network: ${error}`, 'error');
      });
  }
  
  // Example usage
  // Call this function when you want to delete a network
  // deleteNetwork('networkID');
  

  function addNetwork() {
    const networkName = document.getElementById('networkName').value;
    const subnet = document.getElementById('subnet').value;
    const gateway = document.getElementById('gateway').value;
    const internal = document.getElementById('internal').checked;
    const driver = document.getElementById('driver').value;

    // Build the ipam_config based on provided values
    const ipam_config = {
        Driver: 'default',
        Options: {},
        Config: [],
    };

    if (subnet && gateway) {
        ipam_config.Config.push({
            Subnet: subnet,
            Gateway: gateway,
        });
    }

    // Make a POST request to create the network
    fetch('/api/docker-manage/network/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            network_name: networkName,
            ipam_config: ipam_config,
            internal: internal,
            driver: driver,
        }),
    })
        .then(response => response.json())
        .then(result => {
            // Close the modal
            $('#addNetworkModal').modal('hide');
          // Force a complete refresh, fetching the latest content from the server


            // Display a toast with the result
            showColorPaletteToast(result.network_id ? 'Network added successfully' : result.error, result.network_id ? 'success' : 'error');

          })
        .catch(error => {
            console.error('Error adding network:', error);
            showColorPaletteToast('Error adding network. Please try again.', 'error');
        });
}

  </script>
{% endblock %}
